<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Pitjarus Test</title>
    <link href="/assets/css/main.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="icon" type="image/x-icon" href="/assets/favicon.png">
</head>

<body>
    <div class="container">
        <div class="card">
            <div class="filterbox">
                <form>
                    <div class="form-group">
                        <label for="area_ft">Area</label>
                        <select class="form-control form-control-sm" id="area_ft">
                            {{#each area}}
                            <option value="{{area_id}}">{{area_name}}</option>
                            {{/each}}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="area_ft">Start Date</label>
                        <input type="date" class="form-control form-control-sm" id="start_ft">
                    </div>

                    <div class="form-group">
                        <label for="area_ft">End Date</label>
                        <input type="date" class="form-control form-control-sm" id="end_ft">
                    </div>

                    <button type="button" class="btn btn-primary" onclick="updateData()">View</button>
                </form>
            </div>
            <hr>
            <canvas id="myChart" style="max-width:50%;"></canvas>

            <hr>

            <table class="table table-striped" id="mytable">

            </table>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.js"
        integrity="sha512-nO7wgHUoWPYGCNriyGzcFwPSF+bPDOR+NvtOYy2wMcWkrnCNPKBcFEkU80XIN14UVja0Gdnff9EmydyLlOL7mQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

    <script>
        var myChart = new Chart("myChart", {
            type: "bar",
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    borderWidth: 1,
                    borderColor: '#00c0ef',
                    label: ' % ',
                }]
            },
            options: {
                legend: { display: false },
                title: {
                    display: true,
                    text: "Product Report"
                }
            }
        });

        $(document).ready(function () {
            setChart();
            setTable();
        });

        function updateData() {
            myChart.destroy();
            $.ajax({
                type: 'post',
                url: '/updatedata',
                data: {
                    area: $('#area_ft').val(),
                    start_date: $('#start_ft').val(),
                    end_date: $('#end_ft').val()
                },
                dataType: 'json',
                success: function (data) {
                    var myChart = new Chart("myChart", {
                        type: "bar",
                        data: {
                            labels: [],
                            datasets: [{
                                data: [],
                                borderWidth: 1,
                                borderColor: '#00c0ef',
                                label: ' % ',
                            }]
                        },
                        options: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: "Product Report"
                            }
                        }
                    });

                    Object.keys(data).forEach(function (key) {
                        myChart.data.labels.push(data[key].area_name);
                        myChart.data.datasets[0].data.push(data[key].percentage);
                    });

                    myChart.update();
                }
            })
        }

        function setChart() {
            $.ajax({
                type: 'get',
                url: '/getsales',
                success: function (data) {
                    Object.keys(data).forEach(function (key) {
                        myChart.data.labels.push(data[key].area_name);
                        myChart.data.datasets[0].data.push(data[key].percentage);
                    });
                    myChart.update();
                }
            })
        }

        function setTable(){
            $.ajax({
                type: 'get',
                url: '/gettable',
                success: function (data) {  
                    let tbl = "";
                    tbl += "<thead>";
                    tbl += "<tr>";
                    Object.keys(data).forEach(function (key) {
                        tbl += "<th>"+data[key].area_name+" - "+data[key].brand_name+"</th>";
                    });    
                    tbl += "</tr>";
                    tbl += "</thead>"

                    tbl += "<tbody>";
                    tbl += "<tr>";
                    Object.keys(data).forEach(function (key) {
                        tbl += "<td>"+data[key].percentage+"%</td>";
                    });    
                    tbl += "</tr>";
                    tbl += "</tbody>"

                    $("#mytable").append(tbl);
                }
            })
        }
    </script>
</body>

</html>